name: SonarCloud

on:
	push:
		branches: [ lab6Artem ]
	pull_request:
		types: [opened, synchronize, reopened, edited]

jobs:
	build:
		name: Build, Test and Analyze on SonarCloud
		runs-on: ubuntu-latest
		steps:
			- name: Checkout
				uses: actions/checkout@v4

			- name: Setup .NET
				uses: actions/setup-dotnet@v3
				with:
					dotnet-version: '9.0.x'

			- name: Install dotnet-sonarscanner
				run: dotnet tool install --global dotnet-sonarscanner || true

			- name: Restore
				run: dotnet restore

			- name: Begin SonarCloud analysis
				env:
					SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
				run: |
					dotnet sonarscanner begin \
						/k:"${{ secrets.SONAR_PROJECT_KEY }}" \
						/o:"${{ secrets.SONAR_ORGANIZATION }}" \
						/d:sonar.login="${{ secrets.SONAR_TOKEN }}"

			- name: Build
				run: dotnet build --no-restore --configuration Release

			- name: Run tests
				run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=TestResults.trx" || true

			- name: End SonarCloud analysis
				env:
					SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
				run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

# Notes:
# - Create the following GitHub repository secrets: SONAR_TOKEN, SONAR_ORGANIZATION, SONAR_PROJECT_KEY
#   * SONAR_TOKEN: token from your SonarCloud account (generate under My Account -> Security).
#   * SONAR_ORGANIZATION: your SonarCloud organization key (found in SonarCloud settings).
#   * SONAR_PROJECT_KEY: a unique key for this project (e.g. DeQwox_StudyTests).
# - Adjust branches under `on.push` if your default branch is different.
